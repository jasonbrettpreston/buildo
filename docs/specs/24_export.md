# 24 - Data Export

**Status:** Planned
**Last Updated:** 2026-02-14
**Depends On:** `01_database_schema.md`, `06_data_api.md`, `13_auth.md`, `19_search_filter.md`
**Blocks:** None

---

## 1. User Story

> "As a user, I want to export my filtered permit results or saved leads as CSV or PDF for offline use or sharing with my team."

**Acceptance Criteria:**
- Users can export current filtered permit results as CSV or PDF
- Users can export their saved permits list as CSV or PDF
- CSV exports include all visible columns and respect active filters
- PDF reports include a header, summary statistics, permit table, and an optional map snapshot
- Large exports (up to 237K rows) use streaming CSV to avoid memory issues
- Exported files use descriptive naming: `buildo-permits-{date}-{filters}.csv`
- Rate limiting prevents abuse: 10 exports per hour per user
- Export features are gated to Pro and Enterprise subscription plans

---

## 2. Technical Logic

### Export Formats

#### CSV Export
```
Columns (in order):
  permit_num, status, permit_type, description, address, ward, postal_code,
  applicant, issued_date, completed_date, est_cost, actual_cost,
  trades (comma-separated), lead_score, latitude, longitude

Encoding: UTF-8 with BOM (for Excel compatibility)
Line endings: CRLF (Windows-compatible)
Quoting: RFC 4180 compliant (fields with commas, quotes, or newlines are quoted)
Header row: Always included as first row
```

#### PDF Report
```
Layout: A4 portrait
Sections:
  1. Header: Buildo logo, report title, date range, generated timestamp
  2. Summary Stats: Total permits, total estimated value, top trade, top ward
  3. Permit Table: First 500 rows (paginated if needed), columns:
     permit_num, address, applicant, issued_date, est_cost, trades, lead_score
  4. Map Snapshot (optional): Static map image with permit markers
  5. Footer: Page numbers, "Generated by Buildo" attribution

PDF library: @react-pdf/renderer (server-side) or puppeteer for complex layouts
```

### Export Flow

```
1. User clicks "Export" button in toolbar
2. Format selector appears: CSV | PDF
3. For CSV:
   a. Check rate limit (10/hr)
   b. Build query from current filters (reuse search/filter query builder)
   c. Stream results from PostgreSQL using cursor
   d. Transform each row to CSV line
   e. Stream response with Content-Type: text/csv, Content-Disposition: attachment
4. For PDF:
   a. Check rate limit (10/hr)
   b. Fetch first 500 matching permits
   c. Compute summary statistics
   d. Optionally generate static map image via Mapbox Static API
   e. Render PDF document server-side
   f. Return response with Content-Type: application/pdf, Content-Disposition: attachment
```

### Streaming CSV Implementation

```typescript
async function streamCSV(filters: PermitFilters, res: Response) {
  const cursor = db.query(buildPermitQuery(filters)).cursor(500); // 500-row batches

  // Write BOM + header
  res.write('\uFEFF');
  res.write(CSV_HEADER_ROW + '\r\n');

  for await (const batch of cursor) {
    for (const row of batch) {
      res.write(formatCSVRow(row) + '\r\n');
    }
  }

  res.end();
}
```

### File Naming

```
Pattern: buildo-{export_type}-{date}-{filter_summary}.{ext}

Examples:
  buildo-permits-2026-02-14-plumbing-ward10.csv
  buildo-permits-2026-02-14-all.csv
  buildo-saved-leads-2026-02-14.csv
  buildo-report-2026-02-14-hvac-m5v.pdf

filter_summary rules:
  - Include up to 3 active filter values, joined by hyphens
  - If more than 3 filters, append "-filtered"
  - If no filters, use "all"
  - Sanitize: lowercase, replace spaces with hyphens, remove special chars
```

### Rate Limiting

```
Key: export_rate:{user_id}
Store: Redis ZSET with timestamps
Check: ZRANGEBYSCORE key (now - 1 hour) now -> count
Limit: 10 per hour per user
Response on limit: 429 Too Many Requests with Retry-After header
```

### API Endpoints

```
GET /api/export/csv?{filter_params}
  Headers: Content-Type: text/csv; charset=utf-8
           Content-Disposition: attachment; filename="buildo-permits-{date}-{summary}.csv"
  Streaming: yes
  Auth: Required (Pro or Enterprise)

GET /api/export/pdf?{filter_params}&include_map=true|false
  Headers: Content-Type: application/pdf
           Content-Disposition: attachment; filename="buildo-report-{date}-{summary}.pdf"
  Streaming: no (generated in full, then sent)
  Auth: Required (Pro or Enterprise)

GET /api/export/saved?format=csv|pdf
  Exports user's saved permits list
  Auth: Required (Pro or Enterprise)
```

---

## 3. Associated Files

| File | Purpose | Status |
|------|---------|--------|
| `src/lib/export/csv.ts` | CSV formatting, streaming, BOM handling | Planned |
| `src/lib/export/pdf.ts` | PDF report generation with layout and charts | Planned |
| `src/lib/export/naming.ts` | File name generation from filters | Planned |
| `src/lib/export/rate-limit.ts` | Redis-based rate limiting for exports | Planned |
| `src/app/api/export/csv/route.ts` | Streaming CSV export endpoint | Planned |
| `src/app/api/export/pdf/route.ts` | PDF report generation endpoint | Planned |
| `src/app/api/export/saved/route.ts` | Saved permits export endpoint | Planned |
| `src/components/export/ExportButton.tsx` | Export trigger button with format selector | Planned |
| `src/components/export/ExportProgress.tsx` | Progress indicator for large exports | Planned |

---

## 4. Constraints & Edge Cases

- **Memory management:** CSV exports must stream to avoid loading 237K rows into memory. Use PostgreSQL cursors with 500-row batch reads.
- **Excel compatibility:** UTF-8 BOM (`\uFEFF`) is required for Excel to correctly interpret UTF-8 encoded CSV files. Without it, accented characters in Toronto addresses (e.g., Cote-des-Neiges) may display incorrectly.
- **PDF row limit:** PDF reports are capped at 500 permit rows to keep file size reasonable (< 5MB). A note at the bottom indicates total matching count and suggests CSV for full exports.
- **Map snapshot quota:** Mapbox Static API has rate limits. If map generation fails, the PDF is generated without the map section and a note indicates the map was unavailable.
- **Empty export:** If filters match 0 permits, return a CSV with only the header row (no data rows) and a PDF with summary showing 0 results. Do not return an error.
- **Special characters in CSV:** Fields containing commas, double quotes, or newlines must be properly escaped per RFC 4180. Double quotes are escaped by doubling them.
- **Concurrent exports:** A user can only have one active export at a time. If a second export is requested while one is in progress, return 409 Conflict.
- **Network interruption:** Streaming CSV exports may be interrupted by network issues. The client should detect incomplete downloads and offer retry.
- **Filter parity:** The export query must use the exact same filter logic as the search/filter feature to ensure WYSIWYG ("what you see is what you get") behavior.
- **Timezone in filenames:** Dates in filenames use the user's local date (America/Toronto timezone), not UTC.

---

## 5. Data Schema

### No New Tables

Export functionality uses existing `permits`, `permit_trades`, and `trades` tables. Rate limiting uses Redis (no SQL table needed).

### TypeScript Interfaces

```typescript
interface ExportOptions {
  format: 'csv' | 'pdf';
  filters: PermitFilters;          // reuses search/filter types
  source: 'search' | 'saved';     // export filtered results or saved permits
  includemap: boolean;             // PDF only: include map snapshot
}

interface ExportMetadata {
  userId: string;
  format: 'csv' | 'pdf';
  filename: string;
  rowCount: number;
  filters: Record<string, string>;
  generatedAt: Date;
  durationMs: number;
}

interface CSVColumn {
  key: string;                     // database field name
  header: string;                  // display header in CSV
  formatter?: (value: any) => string;  // optional value formatter
}

// Column definitions (order matters)
const CSV_COLUMNS: CSVColumn[] = [
  { key: 'permit_num', header: 'Permit Number' },
  { key: 'status', header: 'Status' },
  { key: 'permit_type', header: 'Type' },
  { key: 'description', header: 'Description' },
  { key: 'address', header: 'Address' },
  { key: 'ward', header: 'Ward' },
  { key: 'postal_code', header: 'Postal Code' },
  { key: 'applicant', header: 'Applicant' },
  { key: 'issued_date', header: 'Issued Date', formatter: formatDate },
  { key: 'completed_date', header: 'Completed Date', formatter: formatDate },
  { key: 'est_cost', header: 'Estimated Cost', formatter: formatCurrency },
  { key: 'actual_cost', header: 'Actual Cost', formatter: formatCurrency },
  { key: 'trades', header: 'Trades', formatter: joinArray },
  { key: 'lead_score', header: 'Lead Score' },
  { key: 'latitude', header: 'Latitude' },
  { key: 'longitude', header: 'Longitude' },
];
```

---

## 6. Integrations

| System | Direction | Purpose |
|--------|-----------|---------|
| Database Schema (`01`) | Upstream | Permits table as data source for exports |
| Permit Data API (`06`) | Reference | Shares query builder patterns for consistent filtering |
| Search & Filter (`19`) | Upstream | Current filter state determines export scope |
| Authentication (`13`) | Reference | User identity for rate limiting and saved permits |
| Subscription (`25`) | Reference | Pro/Enterprise plan required for export access |
| Teams (`22`) | Reference | Team members can export shared saved permits |
| Mapbox Static API | External | Generates map snapshot for PDF reports |
| Redis | External | Rate limit counter storage |

---

## 7. Triad Test Criteria

### A. Logic Layer

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| CSV column order | Export with all columns | Columns match defined order exactly |
| CSV header row | Any export | First row contains column headers |
| CSV BOM present | Any CSV export | File starts with `\uFEFF` byte sequence |
| CSV quoting | Field with comma: "123 Main St, Unit 4" | Field wrapped in double quotes |
| CSV quote escaping | Field with quote: `He said "hello"` | Escaped as `"He said ""hello"""` |
| CSV newline in field | Description with newline | Field wrapped in double quotes, newline preserved |
| Filter application | Filter: trade='plumbing', ward=10 | Only plumbing permits in ward 10 exported |
| Filter parity | Same filters in UI and export | Identical row counts |
| PDF row cap | 1000 matching permits | PDF contains 500 rows with note about remaining 500 |
| PDF summary stats | 100 permits, total $5M | Summary shows count=100, value=$5M |
| Empty export CSV | 0 matching permits | CSV with header row only, no data rows |
| Empty export PDF | 0 matching permits | PDF with summary showing 0 results |
| File naming - filters | Filters: plumbing, ward 10 | `buildo-permits-2026-02-14-plumbing-ward10.csv` |
| File naming - no filters | No active filters | `buildo-permits-2026-02-14-all.csv` |
| File naming - many filters | 5 active filters | Includes first 3 values + `-filtered` suffix |
| Rate limit under | User has made 5 exports this hour | Export allowed |
| Rate limit at limit | User has made 10 exports this hour | 429 with Retry-After header |
| Saved permits export | User has 15 saved permits | All 15 exported with correct data |

### B. UI Layer

| Test Case | Verification |
|-----------|-------------|
| Export button visibility | Export button appears in search results toolbar |
| Format selector | Dropdown shows CSV and PDF options |
| Export button disabled | Button disabled when no results to export |
| Progress indicator | Large CSV export shows progress bar or spinner |
| Download trigger | Browser download dialog opens with correct filename |
| Rate limit feedback | User sees "Export limit reached" message with retry time |
| Plan gate | Free plan users see upgrade prompt when clicking export |
| PDF map toggle | Checkbox to include/exclude map in PDF report |
| Export saved permits | Export option available on saved permits page |
| Concurrent block | Second export attempt shows "Export in progress" message |

### C. Infra Layer

| Test Case | Verification |
|-----------|-------------|
| Streaming CSV | 237K row export streams without exceeding 256MB memory |
| Streaming CSV timing | Full 237K export completes within 30 seconds |
| PostgreSQL cursor | Database cursor reads in 500-row batches |
| PDF generation | Server-side PDF renders within 10 seconds for 500 rows |
| PDF file size | Generated PDF is under 5MB for 500 rows with map |
| Mapbox API call | Static map image generated with correct center and markers |
| Mapbox failure fallback | PDF generates without map section on Mapbox API error |
| Redis rate limit | ZSET correctly tracks export timestamps per user |
| Rate limit TTL | Expired rate limit entries are cleaned up automatically |
| Content-Disposition header | Response includes correct filename in header |
| Content-Type header | CSV returns `text/csv`, PDF returns `application/pdf` |
| Auth middleware | Unauthenticated export requests return 401 |
